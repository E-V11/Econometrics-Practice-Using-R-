---
title: "Two-way fixed effects in PD analysis (PLM Pack. Practice)"
author: "Evan Washington"
date: "`r Sys.Date()`"
output: html_document
---

```{r} 
# Load packages
library(stargazer)
library(plm)
library(dplyr)
library(ggplot2)
library(fixest)
library(lmtest)
library(sandwich)
# Load data
data("Grunfeld", package = "plm")
head(Grunfeld)
summary(Grunfeld)
is.pbalanced(Grunfeld)
```

```{r}
# First Test Model 
model <- plm(log(inv) ~ log(value) + log(capital), #Elasticity 
              data = Grunfeld,
              index = c("firm", "year"),    # Panel Structure
              model = "within",             # Fixed Effects(Firm spec. const.) 
              effect = "twoways")           # Controls for both firm + time FE
# Display results
summary(model)
```

```{r}
# Robust SEs + inference
vc_group <- vcovHC(model, type = 
                     "HC1", cluster = "group")   # firm-clustered (MAIN)
vc_dk    <- vcovSCC(model, type = 
                      "HC0", maxlag = 2)         # Driscoll–Kraay (ROB)
coeftest(model, vcov = vc_group)
coeftest(model, vcov = vc_dk)

# Diagnostics 
pbgtest(model)                      # serial correlation
pcdtest(model, test = "cd")         # cross-sectional dependence

# Corrected Heteroskedasticity test because of Plm object error 
residuals_sq <- residuals(model)^2
fitted_vals <- fitted(model)
het_lm <- lm(residuals_sq ~ fitted_vals + I(fitted_vals^2))
lmtest::bptest(het_lm)              # Breusch–Pagan heteroskedasticity test
```
```{r}
# Model 2: Different specification
modelv2 <- plm(inv ~ value + capital + I(value^2), 
              data = Grunfeld,
              index = c("firm", "year"),
              model = "within",
              effect = "twoways")
# Robust inference for Model 2
cg2  <- coeftest(modelv2, vcov = vcovHC(modelv2, type="HC1", cluster="group"))
cdk2 <- coeftest(modelv2, vcov = vcovSCC(modelv2, type="HC0", maxlag=2))

# Compare models with table
stargazer(model, modelv2, type = "text",
          title = "Model Comparison",
          column.labels = c("Log Model", "Levels Model"))

# scatter plot showing relationship
ggplot(Grunfeld, aes(x = value, y = inv)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +
  geom_smooth(method = "loess", se = FALSE, color = "red", linetype = "dashed") +
  labs(title = "Investment vs Firm Value",
       subtitle = "Blue: Linear fit, Red: Non-linear fit",
       x = "Firm Value", y = "Investment") +
  theme_minimal()
```
## Takeaway
In the two-way FE log model:
$$
\ln inv_{it}=\beta_1\ln value_{it}+\beta_2\ln capital_{it}+\alpha_i+\lambda_t+u_{it},
$$
within-firm elasticities a 1% rise in value ≈ 0.33% ↑ in investment; a 1% rise in capital ≈ 0.08% ↑ (weaker under panel-robust SEs). These are within-firm associations after firm & year FE—**not causal**.

In the levels + quadratic spec:
$$
inv_{it}=\gamma_1\,value_{it}+\gamma_2\,capital_{it}+\gamma_3\,value_{it}^2+\alpha_i+\lambda_t+u_{it},
$$
you get convexity in value such that:
$$
\frac{\partial inv}{\partial value}=\gamma_1+2\gamma_3\,value,\quad \gamma_3>0,
$$
Therefore the marginal effect of value is positive and increasing; capital is strongly positive. Avoid comparing $R^2$ across these (different DVs); rather, evaluate both on $inv$ and, for the log model, use Duan smearing for fit:
$$
\hat{inv}=\exp(\hat y)\cdot \hat S,\qquad \hat S=\frac{1}{n}\sum_i \exp(\hat{\varepsilon}_i).
$$
